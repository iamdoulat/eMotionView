rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---
    function isUserAuthenticated() {
      return request.auth != null;
    }

    // Function to check if the requesting user is a staff member or admin.
    // It safely gets the user's own data from the 'users' collection to check their role.
    function isStaffOrAdmin() {
      if (!isUserAuthenticated()) {
        return false;
      }
      // This is a safe way to check a user's role without causing recursion.
      // We are getting the document of the *requesting user*, not the document they are trying to access.
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && (
        userDoc.data.role == 'Admin' || 
        userDoc.data.role == 'Manager' || 
        userDoc.data.role == 'Staff'
      );
    }

    // Function to check if the user is a full Admin.
    function isAdmin() {
       if (!isUserAuthenticated()) {
        return false;
      }
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data.role == 'Admin';
    }
    
    // --- Collection Rules ---

    // Public read access for products, categories, brands, reviews
    match /{collectionName in ['products', 'categories', 'brands', 'reviews']}/{docId} {
      allow get, list: if true;
      // Writing is restricted to Admins
      allow write: if isAdmin();
    }

    // Customers collection
    match /customers/{userId} {
      // Any authenticated user can create their own customer document during sign-up
      allow create: if isUserAuthenticated() && request.auth.uid == userId;
      // Customers can read/update their own data
      allow get, update: if isUserAuthenticated() && request.auth.uid == userId;
      // Admins/Staff can access any customer data
      allow list, get, update, delete: if isStaffOrAdmin();
    }
    
    // Users (Staff) collection
    match /users/{userId} {
      // A user can read their own document. Staff can read any other staff document.
      allow get: if isUserAuthenticated() && (request.auth.uid == userId || isStaffOrAdmin());
      // Only Staff can list all users.
      allow list: if isStaffOrAdmin();
      // Only Admins can create, update, or delete staff members.
      allow create, update, delete: if isAdmin();
    }

    // Orders collection
    match /orders/{orderId} {
      // Users can create and read their own orders.
      allow create, get: if isUserAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Staff can view all orders.
      allow get, list, update: if isStaffOrAdmin();
    }
  }
}
