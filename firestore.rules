
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin.
    // An admin is defined by their UID existing as a document ID in the 'admins' collection.
    function isUserAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Helper function to check if a user is staff.
    // A staff member has a document in the 'users' collection.
    function isStaff() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Collection: admins
    // Only other admins can see who is an admin.
    match /admins/{adminId} {
      allow read, write: if isUserAdmin();
    }

    // Collection: users (for Staff, Managers, Admins)
    match /users/{userId} {
      // Staff and Admins can see the list of other staff members.
      allow list, get: if isStaff();
      // Only Admins can create or delete staff members.
      allow create, delete: if isUserAdmin();
      // An admin or the user themselves can update a profile.
      allow update: if isUserAdmin() || (request.auth != null && request.auth.uid == userId);
    }

    // Collection: customers
    match /customers/{customerId} {
      // Admins can manage any customer record.
      allow read, write: if isUserAdmin();
      // Customers can read, create, and update their own document.
      allow get, create, update: if request.auth != null && request.auth.uid == customerId;
    }
    
    // Collections for product catalog info are public.
    match /products/{docId} { allow get, list: if true; }
    match /categories/{docId} { allow get, list: if true; }
    match /brands/{docId} { allow get, list: if true; }
    match /attributes/{docId} { allow get, list: if true; }
    match /suppliers/{docId} { allow get, list: if true; }

    // Collection: reviews
    match /reviews/{reviewId} {
      // Anyone can read approved reviews.
      allow get: if resource.data.status == 'approved';
      // Staff can read all reviews for moderation.
      allow list: if isStaff();
      // Admins can manage all reviews.
      allow write: if isUserAdmin();
      // Authenticated users can create reviews.
      allow create: if request.auth != null;
    }

    // Collection: orders
    match /orders/{orderId} {
      // Admins and staff can read any order.
      allow list, get: if isStaff();
      // Customers can only read their own orders.
      allow get: if request.auth != null && resource.data.userId == request.auth.uid;
      // Customers can create orders for themselves.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Admins and staff can update orders (e.g., to change status).
      allow update: if isStaff();
    }
  }
}
