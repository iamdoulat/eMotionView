rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function isAdmin() {
      // Use exists() to prevent errors on non-existent documents.
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Manager');
    }

    // Allow public read access to common asset folders.
    // Allow writes only by admins.
    match /{folder}/{allPaths=**}
      where folder in ['products', 'homepage', 'footer', 'avatars'] {
        allow read: if true;
        allow write: if isAdmin();
    }
    
    // All other paths are private by default (no rules means no access).
  }
}
